<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mapa Censal Coquimbo 2017</title>
    
    <!-- Hojas de estilo -->
    <link rel="stylesheet" href="css/leaflet.css">
    <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
    <link rel="stylesheet" href="css/qgis2web.css">
    <link rel="stylesheet" href="css/fontawesome-all.min.css">
    <link rel="stylesheet" href="css/leaflet.photon.css">
    
    <!-- Scripts externos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    
    <style>
        /* Estilos generales */
        * { box-sizing: border-box; }
        html, body, #map { 
            width: 100%; 
            height: 100%; 
            padding: 0; 
            margin: 0; 
            font-family: 'Segoe UI', 'Roboto', sans-serif;
        }
        
        /* Panel de texto informativo */
        #texto {
            position: fixed;
            bottom: 10px;
            left: 1%;
            right: 75%;
            padding: 15px;
            background-color: #ffffff;
            border: 1px solid #ccc;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            text-align: center;
            font-size: 16px;
            z-index: 9999;
            animation: fadeInUp 1s ease-out;
        }
        
        #cerrarTexto {
            position: absolute;
            top: 8px;
            right: 12px;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: #777;
        }
        
        #cerrarTexto:hover {
            color: #333;
        }
        
        .logo-container {
            margin-bottom: 0.5rem;
        }
        
        #logo {
            width: 60%;
            max-width: 80px;
            height: auto;
        }
        
        /* Panel del gr√°fico - MEJORADO */
        #chartPanel {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 350px;
            max-width: 90vw;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            padding: 15px;
            z-index: 1000;
            transition: all 0.3s ease;
            max-height: 80vh;
            overflow: hidden;
            display: none; /* Oculto inicialmente */
        }
        
        #toggleChart {
            display: none;
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1001;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        #chartTitle {
            text-align: center;
            font-weight: bold;
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 16px;
        }
        
        .chart-container {
            position: relative;
            height: 200px;
            width: 100%;
            margin-bottom: 10px;
        }
        
        /* Leyenda de la tabla - MEJORADA */
        .legend-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        
        .legend-table th {
            background-color: #f5f5f5;
            padding: 5px;
            text-align: left;
            position: sticky;
            top: 0;
        }
        
        .legend-table td {
            padding: 5px;
            border-bottom: 1px solid #eee;
        }
        
        .legend-color {
            display: inline-block;
            width: 12px;
            height: 12px;
            margin-right: 5px;
            border-radius: 2px;
        }
        
        /* Bot√≥n de cerrar gr√°fico */
        #cerrarGrafico {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: #777;
            z-index: 1002;
        }
        
        #cerrarGrafico:hover {
            color: #333;
        }
        
        /* Popups del mapa */
        .leaflet-popup-content table {
            width: 100%;
            font-size: 12px;
            color: #2c3e50;
            background-color: #ffffff;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }
        
        .leaflet-popup-content th,
        .leaflet-popup-content td {
            padding: 4px 6px;
            line-height: 1.2;
            text-align: center;
            vertical-align: middle;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .leaflet-popup-content th {
            background-color: #f5f5f5;
            font-weight: 600;
            color: #34495e;
        }
        
        .leaflet-popup-content tr:last-child td {
            border-bottom: none;
        }
        
        .leaflet-popup-content {
            padding: 0 !important;
        }
        
        /* Animaciones */
        @keyframes fadeInUp {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeOutUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }
        
        @keyframes slideInRight {
            0% { opacity: 0; transform: translateX(100%); }
            100% { opacity: 1; transform: translateX(0); }
        }
        
        @keyframes slideOutRight {
            0% { opacity: 1; transform: translateX(0); }
            100% { opacity: 0; transform: translateX(100%); }
        }
        
        /* RESPONSIVIDAD MEJORADA - ENFOQUE EN M√ìVILES */
        @media (max-width: 768px) {
            #texto {
                right: 50%;
                font-size: 14px;
                padding: 12px;
                bottom: 60px;
            }
            
            #chartPanel {
                width: 95%;
                max-width: 95%;
                right: 2.5%;
                left: 2.5%;
                top: auto;
                bottom: 10px;
                max-height: 65vh;
                padding: 10px;
                transition: all 0.3s ease;
                animation: slideInRight 0.3s ease-out;
            }
            
            #chartPanel.hidden {
                animation: slideOutRight 0.3s ease-out forwards;
            }
            
            #toggleChart {
                display: block;
                bottom: 10px;
                right: 10px;
                top: auto;
            }
            
            .chart-container {
                height: 160px;
            }
            
            .legend-table {
                font-size: 11px;
            }
            
            .legend-table th, 
            .legend-table td {
                padding: 3px;
            }
            
            /* Estados para mostrar/ocultar gr√°fico en m√≥viles */
            .chart-collapsed {
                height: 70px;
                overflow: hidden;
                padding-bottom: 35px;
            }
            
            .chart-collapsed .chart-container,
            .chart-collapsed #chartLegend,
            .chart-collapsed #chartTitle {
                display: none;
            }
        }
        
        @media (max-width: 480px) {
            #texto {
                right: 30%;
                font-size: 13px;
                padding: 10px;
                bottom: 50px;
            }
            
            #chartPanel {
                padding: 8px;
                max-height: 60vh;
            }
            
            .chart-container {
                height: 140px;
            }
            
            #chartTitle {
                font-size: 14px;
                margin-bottom: 8px;
            }
            
            .legend-table {
                font-size: 10px;
            }
            
            .legend-color {
                width: 10px;
                height: 10px;
            }
        }
        
        /* Ocultar elementos en pantallas peque√±as */
        @media only screen and (max-width: 768px) {
            #contenedor { display: none; }
        }
        
        @media only screen and (max-height: 568px) {
            #grafica-container { display: none; }
        }
        
        /* Estilo para controles de capas */
        .leaflet-control-layers {
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            padding: 10px;
        }
        
        /* Mejora para modo m√≥vil: gr√°fico m√°s compacto */
        .mobile-optimized #chartPanel {
            bottom: 5px;
            max-height: 60vh;
        }
        
        .mobile-optimized .chart-container {
            height: 130px;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div id="texto">
        <button id="cerrarTexto">‚úï</button>
        <div class="logo-container">
            <a href="http://mapas.municoquimbo.cl/" target="_blank">
                <img id="logo" src="images/logo.png" alt="Logo Municipalidad de Coquimbo">
            </a>
        </div>
        <strong>
            <br>
            <span style="font-size: 18px;">Estadisticas Proyectos 2021-2025</span><br>
            Ilustre Municipalidad de Coquimbo<br><br>
        </strong>
    </div>
    
    <button id="toggleChart">üìä Gr√°fico</button>
    
    <div id="chartPanel">
        <button id="cerrarGrafico">‚úï</button>
        <div id="chartTitle">Distribuci√≥n por A√±os</div>
        <div class="chart-container">
            <canvas id="zonaChart"></canvas>
        </div>
        
        <table class="legend-table" id="chartLegend">
            <tr>
                <th>A√±o</th>
                <th>Valor</th>
                <th>Porcentaje</th>
            </tr>
            <!-- Las filas se agregar√°n din√°micamente -->
        </table>
    </div>

    <!-- Scripts locales -->
    <script src="js/qgis2web_expressions.js"></script>
    <script src="js/leaflet.js"></script>
    <script src="js/L.Control.Layers.Tree.min.js"></script>
    <script src="js/leaflet.rotatedMarker.js"></script>
    <script src="js/leaflet.pattern.js"></script>
    <script src="js/leaflet-hash.js"></script>
    <script src="js/Autolinker.min.js"></script>
    <script src="js/rbush.min.js"></script>
    <script src="js/labelgun.min.js"></script>
    <script src="js/labels.js"></script>
    <script src="js/leaflet.photon.js"></script>
    <script src="data/SECTORESESTADISTICAS_1.js"></script>
    
    <script>
        // Registrar el plugin de etiquetas de datos
        Chart.register(ChartDataLabels);
        
        // Inicializar mapa
        const map = L.map('map', {
            zoomControl: false,
            maxZoom: 28,
            minZoom: 1,
            center: [-29.9803, -71.3170],  // Vista inicial en Coquimbo
            zoom: 13                       // Nivel de zoom inicial
        });
        
        // Variables globales
        let zonaChartInstance = null;
        let currentChartType = 'pie'; // 'pie' o 'bar'
        const hash = new L.Hash(map);
        const autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});
        const boundsGroup = L.featureGroup([]);
        
        // Colores para las zonas
        const zonaFillColors = {
            'CANTERA BAJA': 'rgba(237,217,42,0.5)',
            'GUANAQUEROS': 'rgba(156,207,79,0.5)',
            'LA HERRADURA': 'rgba(238,60,208,0.5)',
            'PARTE ALTA': 'rgba(28,168,103,0.5)',
            'PE√ëUELAS': 'rgba(15,81,223,0.5)',
            'RINCONADA': 'rgba(102,127,209,0.5)',
            'RURAL': 'rgba(128,174,10,0.5)',
            'SAN JUAN': 'rgba(86,64,159,0.5)',
            'SINDEMPART': 'rgba(146,162,57,0.5)',
            'TIERRAS BLANCAS': 'rgba(85,171,158,0.5)',
            'TONGOY': 'rgba(35,88,213,0.5)'
        };
        
        // Colores para el gr√°fico
        const chartColors = [
            '#3498db', // Azul para 2021
            '#2ecc71', // Verde para 2022
            '#e74c3c', // Rojo para 2023
            '#f39c12', // Naranja para 2024
            '#9b59b6'  // P√∫rpura para 2025
        ];
        
        // Configuraci√≥n de atribuci√≥n
        map.attributionControl.setPrefix(
            '<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; ' +
            '<a href="https://leafletjs.com">Leaflet</a> &middot; ' +
            '<a href="https://qgis.org">QGIS</a>'
        );
        
        // Inicializar controles
        L.control.zoom({ position: 'topleft' }).addTo(map);
        
        // Configurar capa base
        map.createPane('pane_OpenStreetMap_0');
        map.getPane('pane_OpenStreetMap_0').style.zIndex = 400;
        
        const baseLayer = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            pane: 'pane_OpenStreetMap_0',
            opacity: 1.0,
            attribution: '',
            minZoom: 1,
            maxZoom: 28,
            minNativeZoom: 0,
            maxNativeZoom: 19
        });
        
        map.addLayer(baseLayer);
        
        // Configurar capa de sectores
        map.createPane('pane_SECTORESESTADISTICAS_1');
        map.getPane('pane_SECTORESESTADISTICAS_1').style.zIndex = 401;
        map.getPane('pane_SECTORESESTADISTICAS_1').style['mix-blend-mode'] = 'normal';
        
        const sectorLayer = L.geoJson(json_SECTORESESTADISTICAS_1, {
            attribution: '',
            interactive: true,
            dataVar: 'json_SECTORESESTADISTICAS_1',
            layerName: 'layer_SECTORESESTADISTICAS_1',
            pane: 'pane_SECTORESESTADISTICAS_1',
            onEachFeature: pop_SECTORESESTADISTICAS_1,
            style: style_SECTORESESTADISTICAS_1_0,
        });
        
        boundsGroup.addLayer(sectorLayer);
        map.addLayer(sectorLayer);
        
        // Detectar si es dispositivo m√≥vil
        function isMobileDevice() {
            return (typeof window.orientation !== "undefined") || (navigator.userAgent.indexOf('IEMobile') !== -1);
        };
        
        // Verificar si es pantalla peque√±a
        function isSmallScreen() {
            return window.innerWidth <= 768;
        }
        
        // Inicializar estado del panel del gr√°fico
        function initChartPanelState() {
            const chartPanel = document.getElementById('chartPanel');
            const toggleButton = document.getElementById('toggleChart');
            
            // En m√≥viles, ocultar el panel inicialmente
            if (isSmallScreen()) {
                chartPanel.style.display = 'none';
                currentChartType = 'bar';
                chartPanel.classList.add('mobile-optimized');
                toggleButton.style.display = 'none';
            } else {
                // En pantallas grandes: mostrar siempre el panel con gr√°fico circular
                currentChartType = 'pie';
                chartPanel.style.display = 'block';
                chartPanel.classList.remove('mobile-optimized');
                toggleButton.style.display = 'none';
            }
        }
        
        // Inicializar el estado del panel
        initChartPanelState();
        
        // Actualizar el estado al redimensionar la ventana
        window.addEventListener('resize', initChartPanelState);
        
        // Funci√≥n para cerrar el panel de texto
        document.getElementById('cerrarTexto').addEventListener('click', function() {
            const textoPanel = document.getElementById('texto');
            textoPanel.style.animation = 'fadeOutUp 0.5s ease-out forwards';
            setTimeout(() => {
                textoPanel.style.display = 'none';
            }, 500);
        });
        
        // Funci√≥n para cerrar el panel del gr√°fico
        document.getElementById('cerrarGrafico').addEventListener('click', function() {
            const chartPanel = document.getElementById('chartPanel');
            chartPanel.classList.add('hidden');
            
            setTimeout(() => {
                chartPanel.style.display = 'none';
                chartPanel.classList.remove('hidden');
            }, 300);
        });
        
        // Ajustar gr√°fico al redimensionar la ventana
        window.addEventListener('resize', function() {
            if (zonaChartInstance) {
                // Solo redimensionar si el gr√°fico ya existe
                setTimeout(() => {
                    zonaChartInstance.resize();
                }, 300);
            }
        });
        
        // Funciones de utilidad
        function removeEmptyRowsFromPopupContent(content, feature) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            const rows = tempDiv.querySelectorAll('tr');
            
            rows.forEach(row => {
                const td = row.querySelector('td.visible-with-data');
                const key = td ? td.id : '';
                
                if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
                    row.parentNode.removeChild(row);
                }
            });
            
            return tempDiv.innerHTML;
        }
        
        function addClassToPopupIfMedia(content, popup) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            
            if (tempDiv.querySelector('td img')) {
                popup._contentNode.classList.add('media');
                setTimeout(() => popup.update(), 10);
            } else {
                popup._contentNode.classList.remove('media');
            }
        }
        
        function setBounds() {
            if (boundsGroup.getLayers().length) {
                map.fitBounds(boundsGroup.getBounds());
            }
        }
        
        function createPopupRow(label, value) {
            if (value === null) return '';
            return `<tr><th scope="row">${label}</th><td>${autolinker.link(String(value))}</td></tr>`;
        }
        
        // Mostrar panel del gr√°fico
        function showChartPanel() {
            const chartPanel = document.getElementById('chartPanel');
            chartPanel.style.display = 'block';
            chartPanel.classList.remove('hidden');
        }
        
        // Funciones para el gr√°fico
        function updateChart(zona, props, chartType = null) {
            const ctx = document.getElementById('zonaChart').getContext('2d');
            const labels = ['2021', '2022', '2023', '2024', '2025'];
            const data = [
                props['2021'] || 0, 
                props['2022'] || 0, 
                props['2023'] || 0, 
                props['2024'] || 0, 
                props['2025'] || 0
            ];
            
            // Determinar tipo de gr√°fico
            const useChartType = chartType || currentChartType;
            
            // Calcular porcentajes
            const total = data.reduce((a, b) => a + b, 0);
            const percentages = data.map(value => total > 0 ? Math.round((value / total) * 100) : 0);
            
            // Actualizar el t√≠tulo del gr√°fico
            document.getElementById('chartTitle').textContent = `Distribuci√≥n por A√±os - Zona: ${zona}`;
            
            // Actualizar la leyenda con TODOS los a√±os
            updateLegend(labels, data, percentages);
            
            // Mostrar el panel del gr√°fico
            showChartPanel();
            
            // Destruir gr√°fico existente si hay uno
            if (zonaChartInstance) {
                zonaChartInstance.destroy();
            }
            
            // Configuraci√≥n com√∫n para ambos tipos de gr√°ficos
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: true,
                layout: {
                    padding: {
                        top: 10,
                        bottom: 20,
                        left: 10,
                        right: 10
                    }
                },
                plugins: {
                    legend: { 
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.raw || 0;
                                const percentage = percentages[context.dataIndex];
                                return `${label}: ${value} (${percentage}%)`;
                            }
                        }
                    }
                }
            };
            
            // Opciones espec√≠ficas para gr√°fico de pie
            if (useChartType === 'pie') {
                Object.assign(commonOptions, {
                    aspectRatio: 1.5,
                    plugins: {
                        ...commonOptions.plugins,
                        // Mostrar porcentajes en el gr√°fico de torta
                        datalabels: {
                            color: '#fff', // Color blanco para mejor contraste
                            font: {
                                weight: 'bold',
                                size: 11
                            },
                            formatter: (value, context) => {
                                const percentage = percentages[context.dataIndex];
                                return percentage > 5 ? `${percentage}%` : '';
                            }
                        }
                    }
                });
            }
            
            // Opciones espec√≠ficas para gr√°fico de barras
            if (useChartType === 'bar') {
                Object.assign(commonOptions, {
                    indexAxis: 'y',
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: window.innerWidth < 480 ? 10 : 11
                                }
                            }
                        },
                        y: {
                            ticks: {
                                font: {
                                    size: window.innerWidth < 480 ? 10 : 11
                                },
                                padding: 5
                            }
                        }
                    },
                    plugins: {
                        ...commonOptions.plugins,
                        // Ocultar etiquetas en gr√°fico de barras
                        datalabels: {
                            display: false
                        }
                    }
                });
            }
            
            // Crear nuevo gr√°fico - solo una vez
            zonaChartInstance = new Chart(ctx, {
                type: useChartType,
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: chartColors,
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: commonOptions
            });
            
            // Ajustar el panel despu√©s de que el gr√°fico se haya renderizado completamente
            setTimeout(adjustPanelHeight, 100);
        }
        
        function updateLegend(labels, data, percentages) {
            const legend = document.getElementById('chartLegend');
            
            // Limpiar filas existentes (excepto el encabezado)
            while (legend.rows.length > 1) {
                legend.deleteRow(1);
            }
            
            // A√±adir filas a la leyenda para TODOS los a√±os
            labels.forEach((label, index) => {
                // Solo mostrar filas con datos o con porcentaje > 0
                if (data[index] > 0 || percentages[index] > 0) {
                    const row = legend.insertRow();
                    
                    // Celda de a√±o con color
                    const yearCell = row.insertCell();
                    const colorBox = document.createElement('span');
                    colorBox.className = 'legend-color';
                    colorBox.style.backgroundColor = chartColors[index];
                    yearCell.appendChild(colorBox);
                    yearCell.appendChild(document.createTextNode(label));
                    
                    // Celda de valor
                    const valueCell = row.insertCell();
                    valueCell.textContent = data[index];
                    
                    // Celda de porcentaje
                    const percentCell = row.insertCell();
                    percentCell.textContent = `${percentages[index]}%`;
                }
            });
        }
        
        // Ajustar la altura del panel para que no tenga scroll
        function adjustPanelHeight() {
            const chartPanel = document.getElementById('chartPanel');
            const legend = document.getElementById('chartLegend');
            
            // Calcular la altura necesaria
            const chartHeight = document.querySelector('.chart-container').offsetHeight;
            const legendHeight = legend.offsetHeight;
            const titleHeight = document.getElementById('chartTitle').offsetHeight;
            const padding = 50; // Espacio para padding y bordes
            
            const totalHeight = chartHeight + legendHeight + titleHeight + padding;
            
            // Aplicar altura m√°xima basada en la ventana
            const maxHeight = window.innerHeight * 0.7;
            
            if (totalHeight > maxHeight) {
                chartPanel.style.maxHeight = maxHeight + 'px';
                chartPanel.style.overflowY = 'auto';
            } else {
                chartPanel.style.maxHeight = totalHeight + 'px';
                chartPanel.style.overflowY = 'visible';
            }
        }
        
        // Estilo para la capa de sectores
        function style_SECTORESESTADISTICAS_1_0(feature) {
            const zona = String(feature.properties['Zona']);
            return {
                pane: 'pane_SECTORESESTADISTICAS_1',
                opacity: 1,
                color: 'rgba(35,35,35,1.0)',
                dashArray: '',
                lineCap: 'butt',
                lineJoin: 'miter',
                weight: 1.0,
                fill: true,
                fillOpacity: 1,
                fillColor: zonaFillColors[zona] || 'rgba(75,65,216,1.0)',
                interactive: true
            };
        }
        
        // Popup para la capa de sectores - MODIFICADO PARA M√ìVILES
        function pop_SECTORESESTADISTICAS_1(feature, layer) {
            const props = feature.properties;
            
            // En dispositivos m√≥viles, no mostrar popup
            if (isSmallScreen()) {
                // Solo vincular el evento de clic para mostrar el gr√°fico
                layer.on('click', function() {
                    updateChart(props['Zona'], props);
                });
                return;
            }
            
            // Para pantallas grandes, crear el popup normal
            const popupContent = `
                <table>
                    ${createPopupRow('Zona', props['Zona'])}
                    ${createPopupRow('Total', props['Total'])}
                    ${createPopupRow('2025', props['2025'])}
                    ${createPopupRow('2024', props['2024'])}
                    ${createPopupRow('2023', props['2023'])}
                    ${createPopupRow('2022', props['2022'])}
                    ${createPopupRow('2021', props['2021'])}
                </table>
            `;
            
            const content = removeEmptyRowsFromPopupContent(popupContent, feature);
            
            layer.on('popupopen', function(e) {
                addClassToPopupIfMedia(content, e.popup);
            });
            
            layer.on('click', function() {
                updateChart(props['Zona'], props);
            });
            
            layer.bindPopup(content, { maxHeight: 400 });
        }
    </script>
</body>
</html>