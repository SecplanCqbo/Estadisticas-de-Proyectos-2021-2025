<!DOCTYPE html>
<html lang="es">
<head>
ย ย <meta charset="utf-8">
ย ย <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
ย ย <title>Mapa Censal Coquimbo 2017</title>
ย ย 
ย ย <link rel="stylesheet" href="css/leaflet.css">
ย ย <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
ย ย <link rel="stylesheet" href="css/qgis2web.css">
ย ย <link rel="stylesheet" href="css/fontawesome-all.min.css">
ย ย <link rel="stylesheet" href="css/leaflet.photon.css">
ย ย 
ย ย <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
ย ย <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
ย ย 
ย ย <style>
ย ย ย ย /* Estilos generales y del Mapa */
ย ย ย ย * { box-sizing: border-box; }
ย ย ย ย html, body, #map { 
ย ย ย ย ย ย width: 100%; 
ย ย ย ย ย ย height: 100%; 
ย ย ย ย ย ย padding: 0; 
ย ย ย ย ย ย margin: 0; 
ย ย ย ย ย ย font-family: 'Segoe UI', 'Roboto', sans-serif;
ย ย ย ย }
ย ย ย ย 
ย ย ย ย /* ------------------------------------------- */
ย ย ย ย /* --- ESTILOS DEL MODAL DE AVISO (SERIO Y CENTRADO) --- */
ย ย ย ย /* ------------------------------------------- */
ย ย ย ย #disclaimerModal {
ย ย ย ย ย ย position: fixed;
ย ย ย ย ย ย top: 0;
ย ย ย ย ย ย left: 0;
ย ย ย ย ย ย width: 100%;
ย ย ย ย ย ย height: 100%;
ย ย ย ย ย ย /* Fondo gris translรบcido con desenfoque */
ย ย ย ย ย ย background-color: rgba(22, 42, 60, 0.6); /* Gris oscuro corporativo */
ย ย ย ย ย ย z-index: 10000; 
ย ย ย ย ย ย display: block; /* Bloqueamos el flujo de flex para el centrado del contenido */
ย ย ย ย ย ย backdrop-filter: blur(8px); 
ย ย ย ย ย ย -webkit-backdrop-filter: blur(8px);
ย ย ย ย ย ย opacity: 1;
ย ย ย ย ย ย transition: opacity 0.5s ease-out;
ย ย ย ย }

ย ย ย ย #modalContent {
ย ย ย ย ย ย /* CENTRADO ABSOLUTO Y RESPONSIVO */
ย ย ย ย ย ย position: absolute;
ย ย ย ย ย ย top: 50%;
ย ย ย ย ย ย left: 50%;
ย ย ย ย ย ย transform: translate(-50%, -50%); /* CLAVE: Centrado perfecto */

ย ย ย ย ย ย background-color: #ffffff;
ย ย ย ย ย ย color: #2c3e50;
ย ย ย ย ย ย padding: 4vmin; 
ย ย ย ย ย ย border-radius: 12px; 
ย ย ย ย ย ย max-width: 90%; 
ย ย ย ย ย ย width: 480px; 
ย ย ย ย ย ย text-align: center;
ย ย ย ย ย ย box-shadow: 0 15px 50px rgba(0, 0, 0, 0.4); /* Sombra profunda y profesional */
ย ย ย ย ย ย border-top: 5px solid #34495e; /* Lรญnea de acento seria */
ย ย ย ย }

ย ย ย ย #modalContent h2 {
ย ย ย ย ย ย font-size: 2.5vmin; 
ย ย ย ย ย ย min-font-size: 18px; 
ย ย ย ย ย ย margin-top: 0;
ย ย ย ย ย ย margin-bottom: 15px;
ย ย ย ย ย ย color: #34495e; /* Tรญtulo serio/corporativo */
ย ย ย ย ย ย font-weight: 700;
ย ย ย ย }
ย ย ย ย 
ย ย ย ย @media (max-width: 600px) {
ย ย ย ย ย ย #modalContent h2 { font-size: 5vw; }
ย ย ย ย }

ย ย ย ย #modalContent p {
ย ย ย ย ย ย font-size: 1.8vmin; 
ย ย ย ย ย ย min-font-size: 13px;
ย ย ย ย ย ย line-height: 1.6;
ย ย ย ย ย ย margin-bottom: 20px;
ย ย ย ย ย ย color: #555; /* Texto mรกs profesional */
ย ย ย ย }
ย ย ย ย 
ย ย ย ย @media (max-width: 600px) {
ย ย ย ย ย ย #modalContent p { font-size: 3.5vw; }
ย ย ย ย }

ย ย ย ย #acceptDisclaimer {
ย ย ย ย ย ย background-color: #3498db; /* Azul corporativo */
ย ย ย ย ย ย color: white;
ย ย ย ย ย ย border: none;
ย ย ย ย ย ย padding: 12px 30px;
ย ย ย ย ย ย border-radius: 6px;
ย ย ย ย ย ย cursor: pointer;
ย ย ย ย ย ย font-size: 16px;
ย ย ย ย ย ย font-weight: 600;
ย ย ย ย ย ย transition: background-color 0.2s, transform 0.2s;
ย ย ย ย ย ย text-transform: uppercase;
ย ย ย ย }

ย ย ย ย #acceptDisclaimer:hover {
ย ย ย ย ย ย background-color: #2980b9;
ย ย ย ย ย ย transform: translateY(-1px);
ย ย ย ย }

ย ย ย ย @keyframes fadeIn {
ย ย ย ย ย ย from { opacity: 0; transform: scale(0.9); }
ย ย ย ย ย ย to { opacity: 1; transform: scale(1); }
ย ย ย ย }
ย ย ย ย 
ย ย ย ย /* Panel de texto informativo (Inferior Izquierdo) */
ย ย ย ย #texto {
ย ย ย ย ย ย position: fixed;
ย ย ย ย ย ย bottom: 10px;
ย ย ย ย ย ย left: 1%;
ย ย ย ย ย ย right: 75%;
ย ย ย ย ย ย padding: 15px;
ย ย ย ย ย ย background-color: #ffffff;
ย ย ย ย ย ย border: 1px solid #ccc;
ย ย ย ย ย ย border-radius: 12px;
ย ย ย ย ย ย box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
ย ย ย ย ย ย text-align: center;
ย ย ย ย ย ย font-size: 16px;
ย ย ย ย ย ย z-index: 9999;
ย ย ย ย ย ย animation: fadeInUp 1s ease-out;
ย ย ย ย }
ย ย ย ย 
ย ย ย ย #cerrarTexto {
ย ย ย ย ย ย position: absolute;
ย ย ย ย ย ย top: 8px;
ย ย ย ย ย ย right: 12px;
ย ย ย ย ย ย background: none;
ย ย ย ย ย ย border: none;
ย ย ย ย ย ย font-size: 18px;
ย ย ย ย ย ย cursor: pointer;
ย ย ย ย ย ย color: #777;
ย ย ย ย }
ย ย ย ย 
ย ย ย ย #cerrarTexto:hover { color: #333; }
ย ย ย ย 
ย ย ย ย .logo-container { margin-bottom: 0.5rem; }
ย ย ย ย 
ย ย ย ย #logo {
ย ย ย ย ย ย width: 60%;
ย ย ย ย ย ย max-width: 80px;
ย ย ย ย ย ย height: auto;
ย ย ย ย }

ย ย ย ย /* ------------------------------------------- */
ย ย ย ย /* --- ESTILOS DE BLOQUES ESTADรSTICOS --- */
ย ย ย ย /* ------------------------------------------- */
ย ย ย ย #statsContainer {
ย ย ย ย ย ย position: absolute; 
ย ย ย ย ย ย top: 12vh; 
ย ย ย ย ย ย transform: translateY(0); 
ย ย ย ย ย ย left: 10px;
ย ย ย ย ย ย z-index: 1000; 
ย ย ย ย ย ย display: flex; 
ย ย ย ย ย ย flex-direction: column; 
ย ย ย ย ย ย gap: 10px; 
ย ย ย ย ย ย max-width: 200px; 
ย ย ย ย ย ย opacity: 0; 
ย ย ย ย ย ย transition: opacity 0.5s ease-in-out;
ย ย ย ย ย ย 
ย ย ย ย ย ย min-height: 100px; 
ย ย ย ย ย ย max-height: calc(88vh - 180px); 
ย ย ย ย ย ย overflow-y: auto;
ย ย ย ย }
ย ย ย ย 
ย ย ย ย /* Botรณn de cierre para el panel de estadรญsticas */
ย ย ย ย #cerrarStats {
ย ย ย ย ย ย position: absolute;
ย ย ย ย ย ย top: 5px;
ย ย ย ย ย ย right: 5px;
ย ย ย ย ย ย background: none;
ย ย ย ย ย ย border: none;
ย ย ย ย ย ย font-size: 16px;
ย ย ย ย ย ย cursor: pointer;
ย ย ย ย ย ย color: #555;
ย ย ย ย ย ย z-index: 1001;
ย ย ย ย ย ย padding: 0;
ย ย ย ย ย ย line-height: 1;
ย ย ย ย }

ย ย ย ย #statsContainer.hidden {
ย ย ย ย ย ย opacity: 0;
ย ย ย ย ย ย pointer-events: none;
ย ย ย ย ย ย visibility: hidden; 
ย ย ย ย }

ย ย ย ย .stat-block {
ย ย ย ย ย ย background-color: #ffffff;
ย ย ย ย ย ย border-radius: 8px;
ย ย ย ย ย ย padding: 15px;
ย ย ย ย ย ย box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
ย ย ย ย ย ย width: 100%; 
ย ย ย ย ย ย min-width: 150px; 
ย ย ย ย ย ย text-align: center;
ย ย ย ย ย ย transition: transform 0.2s ease;
ย ย ย ย ย ย cursor: default;
ย ย ย ย ย ย border-left: 5px solid #3498db; 
ย ย ย ย }
ย ย ย ย 
ย ย ย ย /* Aรฑadir espacio al bloque superior para el botรณn (sรณlo en el primer bloque) */
ย ย ย ย #total-proyectos-block {
ย ย ย ย ย ย padding-top: 25px; 
ย ย ย ย ย ย position: relative;
ย ย ย ย }

ย ย ย ย .stat-block:hover {
ย ย ย ย ย ย transform: translateY(-2px);
ย ย ย ย }

ย ย ย ย .stat-block .stat-label {
ย ย ย ย ย ย font-size: 14px;
ย ย ย ย ย ย color: #7f8c8d; 
ย ย ย ย ย ย margin-bottom: 5px;
ย ย ย ย ย ย font-weight: 500;
ย ย ย ย }

ย ย ย ย .stat-block .stat-value {
ย ย ย ย ย ย font-size: 24px;
ย ย ย ย ย ย font-weight: bold;
ย ย ย ย ย ย color: #2c3e50;
ย ย ย ย }

ย ย ย ย /* Colores de acento */
ย ย ย ย #total-proyectos-block { border-left-color: #3498db; }
ย ย ย ย #promedio-anual-block { border-left-color: #e67e22; }
ย ย ย ย #max-ano-block { border-left-color: #2ecc71; }
ย ย ย ย 
ย ย ย ย /* Panel del grรกfico (Derecha) */
ย ย ย ย #chartPanel {
ย ย ย ย ย ย position: absolute;
ย ย ย ย ย ย top: 10px;
ย ย ย ย ย ย right: 10px;
ย ย ย ย ย ย width: 350px;
ย ย ย ย ย ย max-width: 90vw;
ย ย ย ย ย ย background-color: #fff;
ย ย ย ย ย ย border-radius: 8px;
ย ย ย ย ย ย box-shadow: 0 2px 6px rgba(0,0,0,0.2);
ย ย ย ย ย ย padding: 15px;
ย ย ย ย ย ย z-index: 1000;
ย ย ย ย ย ย transition: all 0.3s ease;
ย ย ย ย ย ย max-height: 80vh;
ย ย ย ย ย ย overflow: hidden;
ย ย ย ย ย ย display: none; /* Estado inicial oculto */
ย ย ย ย }
ย ย ย ย 
ย ย ย ย #toggleChart {
ย ย ย ย ย ย display: none;
ย ย ย ย ย ย position: absolute;
ย ย ย ย ย ย top: 10px;
ย ย ย ย ย ย right: 10px;
ย ย ย ย ย ย z-index: 1001;
ย ย ย ย ย ย background: #fff;
ย ย ย ย ย ย border: 1px solid #ccc;
ย ย ย ย ย ย border-radius: 4px;
ย ย ย ย ย ย padding: 5px 10px;
ย ย ย ย ย ย font-size: 14px;
ย ย ย ย ย ย cursor: pointer;
ย ย ย ย ย ย box-shadow: 0 1px 3px rgba(0,0,0,0.2);
ย ย ย ย }
ย ย ย ย 
ย ย ย ย #chartTitle {
ย ย ย ย ย ย text-align: center;
ย ย ย ย ย ย font-weight: bold;
ย ย ย ย ย ย margin-bottom: 10px;
ย ย ย ย ย ย color: #2c3e50;
ย ย ย ย ย ย font-size: 16px;
ย ย ย ย }
ย ย ย ย 
ย ย ย ย .chart-container {
ย ย ย ย ย ย position: relative;
ย ย ย ย ย ย height: 200px;
ย ย ย ย ย ย width: 100%;
ย ย ย ย ย ย margin-bottom: 10px;
ย ย ย ย }
ย ย ย ย 
ย ย ย ย /* Leyenda de la tabla */
ย ย ย ย .legend-table {
ย ย ย ย ย ย width: 100%;
ย ย ย ย ย ย border-collapse: collapse;
ย ย ย ย ย ย font-size: 12px;
ย ย ย ย }
ย ย ย ย 
ย ย ย ย .legend-table th {
ย ย ย ย ย ย background-color: #f5f5f5;
ย ย ย ย ย ย padding: 5px;
ย ย ย ย ย ย text-align: left;
ย ย ย ย ย ย position: sticky;
ย ย ย ย ย ย top: 0;
ย ย ย ย }
ย ย ย ย 
ย ย ย ย .legend-table td {
ย ย ย ย ย ย padding: 5px;
ย ย ย ย ย ย border-bottom: 1px solid #eee;
ย ย ย ย }
ย ย ย ย 
ย ย ย ย .legend-color {
ย ย ย ย ย ย display: inline-block;
ย ย ย ย ย ย width: 12px;
ย ย ย ย ย ย height: 12px;
ย ย ย ย ย ย margin-right: 5px;
ย ย ย ย ย ย border-radius: 2px;
ย ย ย ย }
ย ย ย ย 
ย ย ย ย /* Botรณn de cerrar grรกfico */
ย ย ย ย #cerrarGrafico {
ย ย ย ย ย ย position: absolute;
ย ย ย ย ย ย top: 8px;
ย ย ย ย ย ย right: 8px;
ย ย ย ย ย ย background: none;
ย ย ย ย ย ย border: none;
ย ย ย ย ย ย font-size: 16px;
ย ย ย ย ย ย cursor: pointer;
ย ย ย ย ย ย color: #777;
ย ย ย ย ย ย z-index: 1002;
ย ย ย ย }
ย ย ย ย 
ย ย ย ย #cerrarGrafico:hover { color: #333; }
ย ย ย ย 
ย ย ย ย /* Popups del mapa */
ย ย ย ย .leaflet-popup-content table {
ย ย ย ย ย ย width: 100%;
ย ย ย ย ย ย font-size: 12px;
ย ย ย ย ย ย color: #2c3e50;
ย ย ย ย ย ย background-color: #ffffff;
ย ย ย ย ย ย border-radius: 6px;
ย ย ย ย ย ย box-shadow: 0 2px 6px rgba(0,0,0,0.1);
ย ย ย ย ย ย overflow: hidden;
ย ย ย ย ย ย border: 1px solid #e0e0e0;
ย ย ย ย }
ย ย ย ย 
ย ย ย ย .leaflet-popup-content th,
ย ย ย ย .leaflet-popup-content td {
ย ย ย ย ย ย padding: 4px 6px;
ย ย ย ย ย ย line-height: 1.2;
ย ย ย ย ย ย text-align: center;
ย ย ย ย ย ย vertical-align: middle;
ย ย ย ย ย ย border-bottom: 1px solid #f0f0f0;
ย ย ย ย }
ย ย ย ย 
ย ย ย ย .leaflet-popup-content th {
ย ย ย ย ย ย background-color: #f5f5f5;
ย ย ย ย ย ย font-weight: 600;
ย ย ย ย ย ย color: #34495e;
ย ย ย ย }
ย ย ย ย 
ย ย ย ย .leaflet-popup-content tr:last-child td {
ย ย ย ย ย ย border-bottom: none;
ย ย ย ย }
ย ย ย ย 
ย ย ย ย .leaflet-popup-content {
ย ย ย ย ย ย padding: 0 !important;
ย ย ย ย }
ย ย ย ย 
ย ย ย ย /* Animaciones */
ย ย ย ย @keyframes fadeInUp {
ย ย ย ย ย ย 0% { opacity: 0; transform: translateY(20px); }
ย ย ย ย ย ย 100% { opacity: 1; transform: translateY(0); }
ย ย ย ย }
ย ย ย ย 
ย ย ย ย @keyframes fadeOutUp {
ย ย ย ย ย ย 0% { opacity: 1; transform: translateY(0); }
ย ย ย ย ย ย 100% { opacity: 0; transform: translateY(-20px); }
ย ย ย ย }
ย ย ย ย 
ย ย ย ย @keyframes slideInRight {
ย ย ย ย ย ย 0% { transform: translateX(100%); opacity: 0; }
ย ย ย ย ย ย 100% { transform: translateX(0); opacity: 1; }
ย ย ย ย }
ย ย ย ย 
ย ย ย ย @keyframes slideOutRight {
ย ย ย ย ย ย 0% { transform: translateX(0); opacity: 1; }
ย ย ย ย ย ย 100% { transform: translateX(100%); opacity: 0; }
ย ย ย ย }
ย ย ย ย 
ย ย ย ย /* RESPONSIVIDAD MรVIL */
ย ย ย ย @media (max-width: 768px) {
ย ย ย ย ย ย 
ย ย ย ย ย ย #statsContainer {
ย ย ย ย ย ย ย ย top: 75px; 
ย ย ย ย ย ย ย ย transform: none; 
ย ย ย ย ย ย ย ย left: 10px;
ย ย ย ย ย ย ย ย max-width: calc(100% - 20px); 
ย ย ย ย ย ย ย ย width: auto; 
ย ย ย ย ย ย ย ย flex-direction: column; 
ย ย ย ย ย ย ย ย justify-content: flex-start;
ย ย ย ย ย ย ย ย gap: 5px; 
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย max-height: calc(100vh - 170px); 
ย ย ย ย ย ย ย ย overflow-y: auto; 
ย ย ย ย ย ย }

ย ย ย ย ย ย .stat-block {
ย ย ย ย ย ย ย ย min-width: 130px; 
ย ย ย ย ย ย ย ย max-width: 100%;
ย ย ย ย ย ย ย ย padding: 10px;
ย ย ย ย ย ย }

ย ย ย ย ย ย .stat-block .stat-value {
ย ย ย ย ย ย ย ย font-size: 20px;
ย ย ย ย ย ย }

ย ย ย ย ย ย .stat-block .stat-label {
ย ย ย ย ย ย ย ย font-size: 12px;
ย ย ย ย ย ย }

ย ย ย ย ย ย #texto {
ย ย ย ย ย ย ย ย right: 50%;
ย ย ย ย ย ย ย ย font-size: 14px;
ย ย ย ย ย ย ย ย padding: 12px;
ย ย ย ย ย ย ย ย bottom: 60px;
ย ย ย ย ย ย }
ย ย ย ย ย ย 
ย ย ย ย ย ย #chartPanel {
ย ย ย ย ย ย ย ย /* Estilos base para mรณvil */
ย ย ย ย ย ย ย ย width: 95%;
ย ย ย ย ย ย ย ย max-width: 95%;
ย ย ย ย ย ย ย ย right: 2.5%;
ย ย ย ย ย ย ย ย left: 2.5%;
ย ย ย ย ย ย ย ย top: auto;
ย ย ย ย ย ย ย ย bottom: 10px;
ย ย ย ย ย ย ย ย max-height: 65vh;
ย ย ย ย ย ย ย ย padding: 10px;
ย ย ย ย ย ย ย ย transition: none; /* Desactivamos la transiciรณn CSS para usar keyframes */
ย ย ย ย ย ย ย ย transform: translateX(100%); /* Lo sacamos de la vista inicial */
ย ย ย ย ย ย ย ย opacity: 0;
ย ย ย ย ย ย }
ย ย ย ย ย ย 
ย ย ย ย ย ย /* Clase para MOSTRAR (Inicia la animaciรณn de entrada) */
ย ย ย ย ย ย #chartPanel.is-visible {
ย ย ย ย ย ย ย ย display: block; /* Necesario para que la animaciรณn se ejecute */
ย ย ย ย ย ย ย ย animation: slideInRight 0.3s ease-out forwards;
ย ย ย ย ย ย }
ย ย ย ย ย ย 
ย ย ย ย ย ย /* Clase para OCULTAR (Inicia la animaciรณn de salida) */
ย ย ย ย ย ย #chartPanel.is-hiding {
ย ย ย ย ย ย ย ย animation: slideOutRight 0.3s ease-out forwards;
ย ย ย ย ย ย }
ย ย ย ย ย ย 
ย ย ย ย ย ย #toggleChart {
ย ย ย ย ย ย ย ย display: block;
ย ย ย ย ย ย ย ย bottom: 10px;
ย ย ย ย ย ย ย ย right: 10px;
ย ย ย ย ย ย ย ย top: auto;
ย ย ย ย ย ย }
ย ย ย ย ย ย 
ย ย ย ย ย ย .chart-container {
ย ย ย ย ย ย ย ย height: 160px;
ย ย ย ย ย ย }
ย ย ย ย ย ย 
ย ย ย ย ย ย .legend-table {
ย ย ย ย ย ย ย ย font-size: 11px;
ย ย ย ย ย ย }
ย ย ย ย }
ย ย ย ย 
ย ย ย ย @media (max-width: 480px) {
ย ย ย ย ย ย #texto {
ย ย ย ย ย ย ย ย right: 30%;
ย ย ย ย ย ย ย ย font-size: 13px;
ย ย ย ย ย ย ย ย padding: 10px;
ย ย ย ย ย ย ย ย bottom: 50px;
ย ย ย ย ย ย }
ย ย ย ย ย ย 
ย ย ย ย ย ย #chartPanel {
ย ย ย ย ย ย ย ย padding: 8px;
ย ย ย ย ย ย ย ย max-height: 60vh;
ย ย ย ย ย ย }
ย ย ย ย ย ย 
ย ย ย ย ย ย .chart-container {
ย ย ย ย ย ย ย ย height: 140px;
ย ย ย ย ย ย }
ย ย ย ย ย ย 
ย ย ย ย ย ย .stat-block {
ย ย ย ย ย ย ย ย min-width: 100px;
ย ย ย ย ย ย }
ย ย ย ย }
ย ย </style>
</head>
<body>
ย ย 
ย ย <div id="disclaimerModal" style="display: block;">
ย ย ย ย <div id="modalContent">
ย ย ย ย ย ย <h2>โ๏ธ Aviso de Uso de Datos Referenciales</h2>
ย ย ย ย ย ย <p>La informaciรณn contenida en este mapa es de **carรกcter referencial y preliminar**. Los datos se presentan para fines ilustrativos y pueden no reflejar la situaciรณn oficial o mรกs reciente.</p>
ย ย ย ย ย ย <p><strong>Se requiere validaciรณn oficial para cualquier toma de decisiรณn o uso legal de la informaciรณn.</strong></p>
ย ย ย ย ย ย <button id="acceptDisclaimer">Entendido y Aceptar</button>
ย ย ย ย </div>
ย ย </div>

ย ย <div id="map"></div>
ย ย 
ย ย <div id="statsContainer">
ย ย ย ย <button id="cerrarStats">โ</button>
ย ย ย ย 
ย ย ย ย <div class="stat-block" id="total-proyectos-block">
ย ย ย ย ย ย <div class="stat-label" id="totalProjectsLabel">Total Proyectos (Comuna)</div>
ย ย ย ย ย ย <div class="stat-value" id="totalProyectosValue">0</div>
ย ย ย ย </div>

ย ย ย ย <div class="stat-block" id="promedio-anual-block">
ย ย ย ย ย ย <div class="stat-label">Promedio Anual</div>
ย ย ย ย ย ย <div class="stat-value" id="promedioAnualValue">0</div>
ย ย ย ย </div>

ย ย ย ย <div class="stat-block" id="max-ano-block">
ย ย ย ย ย ย <div class="stat-label">Aรฑo de Mayor Inversiรณn</div>
ย ย ย ย ย ย <div class="stat-value" id="maxAnoValue">N/A</div>
ย ย ย ย </div>
ย ย </div>
ย ย 
ย ย <div id="texto">
ย ย ย ย <button id="cerrarTexto">โ</button>
ย ย ย ย <div class="logo-container">
ย ย ย ย ย ย <a href="http://mapas.municoquimbo.cl/" target="_blank">
ย ย ย ย ย ย ย ย <img id="logo" src="images/logo.png" alt="Logo Municipalidad de Coquimbo">
ย ย ย ย ย ย </a>
ย ย ย ย </div>
ย ย ย ย <strong>
ย ย ย ย ย ย <br>
ย ย ย ย ย ย <span style="font-size: 18px;">Estadisticas Proyectos 2021-2025</span><br>
ย ย ย ย ย ย Ilustre Municipalidad de Coquimbo<br><br>
ย ย ย ย </strong>
ย ย </div>
ย ย 
ย ย <button id="toggleChart">๐ Grรกfico</button>
ย ย 
ย ย <div id="chartPanel">
ย ย ย ย <button id="cerrarGrafico">โ</button>
ย ย ย ย <div id="chartTitle">Distribuciรณn por Aรฑos</div>
ย ย ย ย <div class="chart-container">
ย ย ย ย ย ย <canvas id="zonaChart"></canvas>
ย ย ย ย </div>
ย ย ย ย 
ย ย ย ย <table class="legend-table" id="chartLegend">
ย ย ย ย ย ย <tr>
ย ย ย ย ย ย ย ย <th>Aรฑo</th>
ย ย ย ย ย ย ย ย <th>Valor</th>
ย ย ย ย ย ย ย ย <th>Porcentaje</th>
ย ย ย ย ย ย </tr>
ย ย ย ย ย ย </table>
ย ย </div>

ย ย <script src="js/qgis2web_expressions.js"></script>
ย ย <script src="js/leaflet.js"></script>
ย ย <script src="js/L.Control.Layers.Tree.min.js"></script>
ย ย <script src="js/leaflet.rotatedMarker.js"></script>
ย ย <script src="js/leaflet.pattern.js"></script>
ย ย <script src="js/leaflet-hash.js"></script>
ย ย <script src="js/Autolinker.min.js"></script>
ย ย <script src="js/rbush.min.js"></script>
ย ย <script src="js/labelgun.min.js"></script>
ย ย <script src="js/labels.js"></script>
ย ย <script src="js/leaflet.photon.js"></script>
ย ย ย ย <script src="data/SECTORESESTADISTICAS_1.js"></script>
ย ย 
ย ย <script>
ย ย ย ย // Registrar el plugin de etiquetas de datos
ย ย ย ย Chart.register(ChartDataLabels);
ย ย ย ย 
ย ย ย ย // Inicializar mapa
ย ย ย ย const map = L.map('map', {
ย ย ย ย ย ย zoomControl: false,
ย ย ย ย ย ย maxZoom: 28,
ย ย ย ย ย ย minZoom: 1,
ย ย ย ย ย ย center: [-29.9803, -71.3170], 
ย ย ย ย ย ย zoom: 13
ย ย ย ย });
ย ย ย ย 
ย ย ย ย // Variables globales
ย ย ย ย let zonaChartInstance = null;
ย ย ย ย let currentChartType = 'pie';
ย ย ย ย const hash = new L.Hash(map);
ย ย ย ย const autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});
ย ย ย ย const boundsGroup = L.featureGroup([]);
ย ย ย ย 
ย ย ย ย // Colores para las zonas
ย ย ย ย const zonaFillColors = {
ย ย ย ย ย ย 'CANTERA BAJA': 'rgba(237,217,42,0.5)', 'GUANAQUEROS': 'rgba(156,207,79,0.5)',
ย ย ย ย ย ย 'LA HERRADURA': 'rgba(238,60,208,0.5)', 'PARTE ALTA': 'rgba(28,168,103,0.5)',
ย ย ย ย ย ย 'PEรUELAS': 'rgba(15,81,223,0.5)', 'RINCONADA': 'rgba(102,127,209,0.5)',
ย ย ย ย ย ย 'RURAL': 'rgba(128,174,10,0.5)', 'SAN JUAN': 'rgba(86,64,159,0.5)',
ย ย ย ย ย ย 'SINDEMPART': 'rgba(146,162,57,0.5)', 'TIERRAS BLANCAS': 'rgba(85,171,158,0.5)',
ย ย ย ย ย ย 'TONGOY': 'rgba(35,88,213,0.5)'
ย ย ย ย };
ย ย ย ย 
ย ย ย ย // Colores para el grรกfico
ย ย ย ย const chartColors = ['#3498db', '#2ecc71', '#e74c3c', '#f39c12', '#9b59b6'];
ย ย ย ย 
ย ย ย ย // Configuraciรณn de atribuciรณn
ย ย ย ย map.attributionControl.setPrefix(
ย ย ย ย ย ย '<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; ' +
ย ย ย ย ย ย '<a href="https://leafletjs.com">Leaflet</a> &middot; ' +
ย ย ย ย ย ย '<a href="https://qgis.org">QGIS</a>'
ย ย ย ย );
ย ย ย ย 
ย ย ย ย // Inicializar controles y capa base
ย ย ย ย L.control.zoom({ position: 'topleft' }).addTo(map);
ย ย ย ย 
ย ย ย ย map.createPane('pane_OpenStreetMap_0');
ย ย ย ย map.getPane('pane_OpenStreetMap_0').style.zIndex = 400;
ย ย ย ย 
ย ย ย ย const baseLayer = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
ย ย ย ย ย ย pane: 'pane_OpenStreetMap_0', opacity: 1.0, attribution: '', minZoom: 1, maxZoom: 28,
ย ย ย ย ย ย minNativeZoom: 0, maxNativeZoom: 19
ย ย ย ย });
ย ย ย ย 
ย ย ย ย map.addLayer(baseLayer);
ย ย ย ย 
ย ย ย ย // Capa de sectores
ย ย ย ย map.createPane('pane_SECTORESESTADISTICAS_1');
ย ย ย ย map.getPane('pane_SECTORESESTADISTICAS_1').style.zIndex = 401;
ย ย ย ย map.getPane('pane_SECTORESESTADISTICAS_1').style['mix-blend-mode'] = 'normal';
ย ย ย ย 
ย ย ย ย const sectorLayer = L.geoJson(json_SECTORESESTADISTICAS_1, {
ย ย ย ย ย ย attribution: '', interactive: true, dataVar: 'json_SECTORESESTADISTICAS_1',
ย ย ย ย ย ย layerName: 'layer_SECTORESESTADISTICAS_1', pane: 'pane_SECTORESESTADISTICAS_1',
ย ย ย ย ย ย onEachFeature: pop_SECTORESESTADISTICAS_1, style: style_SECTORESESTADISTICAS_1_0,
ย ย ย ย });
ย ย ย ย 
ย ย ย ย boundsGroup.addLayer(sectorLayer);
ย ย ย ย map.addLayer(sectorLayer);
ย ย ย ย 
ย ย ย ย // CORRECCIรN: Forzar el cรกlculo de tamaรฑo de Leaflet para evitar mapa en blanco
ย ย ย ย setTimeout(function () { 
ย ย ย ย ย ย map.invalidateSize(); 
ย ย ย ย ย ย // updateStatsOnMove() se llama despuรฉs de aceptar el disclaimer.
ย ย ย ย }, 400); 

ย ย ย ย 
ย ย ย ย /* ================================================= */
ย ย ย ย /* === FUNCIONALIDAD DE BLOQUES ESTADรSTICOS DINรMICOS === */
ย ย ย ย /* ================================================= */

ย ย ย ย function calculateAndDisplayStats(data, context = 'Comuna') {
ย ย ย ย ย ย const years = ['2021', '2022', '2023', '2024', '2025'];
ย ย ย ย ย ย let totalProyectos = 0;
ย ย ย ย ย ย const projectsByYear = {};
ย ย ย ย ย ย 
ย ย ย ย ย ย years.forEach(year => projectsByYear[year] = 0);

ย ย ย ย ย ย data.features.forEach(feature => {
ย ย ย ย ย ย ย ย const props = feature.properties;
ย ย ย ย ย ย ย ย const totalZona = props['Total'] || years.reduce((sum, year) => sum + (props[year] || 0), 0);
ย ย ย ย ย ย ย ย totalProyectos += totalZona;
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย years.forEach(year => {
ย ย ย ย ย ย ย ย ย ย projectsByYear[year] += props[year] || 0;
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย });
ย ย ย ย ย ย 
ย ย ย ย ย ย // 1. Promedio Anual
ย ย ย ย ย ย const numYears = years.length;
ย ย ย ย ย ย const promedioAnual = numYears > 0 ? Math.round(totalProyectos / numYears) : 0;

ย ย ย ย ย ย // 2. Aรฑo Mรกximo
ย ย ย ย ย ย let maxProjects = -1;
ย ย ย ย ย ย let maxYear = 'N/A';
ย ย ย ย ย ย 
ย ย ย ย ย ย for (const year of years) {
ย ย ย ย ย ย ย ย if (projectsByYear[year] > maxProjects) {
ย ย ย ย ย ย ย ย ย ย maxProjects = projectsByYear[year];
ย ย ย ย ย ย ย ย ย ย maxYear = year;
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย ย ย 
ย ย ย ย ย ย // 3. Actualizar el DOM y mostrar
ย ย ย ย ย ย document.getElementById('totalProyectosValue').textContent = totalProyectos.toLocaleString('es-CL');
ย ย ย ย ย ย document.getElementById('promedioAnualValue').textContent = promedioAnual.toLocaleString('es-CL');
ย ย ย ย ย ย document.getElementById('maxAnoValue').textContent = `${maxYear} (${maxProjects.toLocaleString('es-CL')})`;
ย ย ย ย ย ย 
ย ย ย ย ย ย // Actualizar la etiqueta para indicar el contexto de los datos
ย ย ย ย ย ย const projectsLabel = document.getElementById('totalProjectsLabel');
ย ย ย ย ย ย if (projectsLabel) {
ย ย ย ย ย ย ย ย projectsLabel.textContent = `Total Proyectos (${context})`;
ย ย ย ย ย ย }
ย ย ย ย ย ย 
ย ย ย ย ย ย // Asegura que el contenedor se muestre si no tiene la clase 'hidden'
ย ย ย ย ย ย if (!document.getElementById('statsContainer').classList.contains('hidden')) {
ย ย ย ย ย ย ย ย ยdocument.getElementById('statsContainer').style.opacity = 1;
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย /* === FUNCIรN: ACTUALIZAR ESTADรSTICAS POR VISTA (DINรMICO) === */
ย ย ย ย function updateStatsOnMove() {
ย ย ย ย ย ย if (typeof json_SECTORESESTADISTICAS_1 === 'undefined') return;

ย ย ย ย ย ย const currentBounds = map.getBounds();
ย ย ย ย ย ย const allFeatures = json_SECTORESESTADISTICAS_1.features;
ย ย ย ย ย ย const visibleFeatures = [];

ย ย ย ย ย ย // 1. Filtrar las geometrรญas visibles
ย ย ย ย ย ย allFeatures.forEach(feature => {
ย ย ย ย ย ย ย ย const featureBounds = L.geoJson(feature).getBounds();
ย ย ย ย ย ย ย ย const center = featureBounds.getCenter();
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย // Usamos el centro del polรญgono para determinar la visibilidad
ย ย ย ย ย ย ย ย if (currentBounds.contains(center)) {
ย ย ย ย ย ย ย ย ย ย visibleFeatures.push(feature);
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย });

ย ย ย ย ย ย const visibleData = {
ย ย ย ย ย ย ย ย type: "FeatureCollection",
ย ย ย ย ย ย ย ย features: visibleFeatures
ย ย ย ย ย ย };

ย ย ย ย ย ย const context = visibleFeatures.length === allFeatures.length ? 'Comuna' : 'En Vista';
ย ย ย ย ย ย 
ย ย ย ย ย ย // 2. Recalcular y mostrar las estadรญsticas con los datos filtrados
ย ย ย ย ย ย calculateAndDisplayStats(visibleData, context);
ย ย ย ย ย ย 
ย ย ย ย ย ย // 3. Opcional: Actualizar el grรกfico si solo se ve 1 zona
ย ย ย ย ย ย if (visibleFeatures.length === 1 && isChartPanelVisible()) {
ย ย ย ย ย ย ย ย ยconst props = visibleFeatures[0].properties;
ย ย ย ย ย ย ย ย ยupdateChart(props['Zona'], props);
ย ย ย ย ย ย } else if (visibleFeatures.length === 0) {
ย ย ย ย ย ย ย ย document.getElementById('maxAnoValue').textContent = 'N/A';
ย ย ย ย ย ย }
ย ย ย ย }
ย ย ย ย 
ย ย ย ย // Escucha eventos de movimiento/zoom en el mapa para actualizar las estadรญsticas dinรกmicas
ย ย ย ย map.on('moveend', updateStatsOnMove);


ย ย ย ย /* ================================================= */
ย ย ย ย /* === FUNCIONES DE GRรFICO (Corregidas y Animadas) === */
ย ย ย ย /* ================================================= */
ย ย ย ย 
ย ย ย ย function showChartPanel() {
ย ย ย ย ย ย const chartPanel = document.getElementById('chartPanel');
ย ย ย ย ย ย chartPanel.style.display = 'block';

ย ย ย ย ย ย if (isSmallScreen()) {
ย ย ย ย ย ย ย ย // Para mรณvil, usamos la clase para la animaciรณn
ย ย ย ย ย ย ย ย chartPanel.classList.remove('is-hiding');
ย ย ย ย ย ย ย ย chartPanel.classList.add('is-visible');
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย // Para desktop, volvemos a mostrar y restauramos la posiciรณn
ย ย ย ย ย ย ย ย chartPanel.style.transform = 'none';
ย ย ย ย ย ย ย ย chartPanel.style.opacity = 1;
ย ย ย ย ย ย }
ย ย ย ย }
ย ย ย ย 
ย ย ย ย function hideChartPanel() {
ย ย ย ย ย ย const chartPanel = document.getElementById('chartPanel');

ย ย ย ย ย ย if (isSmallScreen()) {
ย ย ย ย ย ย ย ย chartPanel.classList.remove('is-visible');
ย ย ย ย ย ย ย ย chartPanel.classList.add('is-hiding');
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย // Oculta el elemento despuรฉs de que la animaciรณn termine (300ms)
ย ย ย ย ย ย ย ย setTimeout(() => {
ย ย ย ย ย ย ย ย ย ย chartPanel.style.display = 'none';
ย ย ย ย ย ย ย ย ย ย chartPanel.classList.remove('is-hiding');
ย ย ย ย ย ย ย ย }, 300); 

ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย // Para desktop, simplemente oculta
ย ย ย ย ย ย ย ย chartPanel.style.display = 'none';
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย function isChartPanelVisible() {
ย ย ย ย ย ย const chartPanel = document.getElementById('chartPanel');
ย ย ย ย ย ย // Consideramos visible si no estรก en display: none
ย ย ย ย ย ย return chartPanel.style.display !== 'none';
ย ย ย ย }

ย ย ย ย function updateChart(zona, props, chartType = null) {
ย ย ย ย ย ย const ctx = document.getElementById('zonaChart').getContext('2d');
ย ย ย ย ย ย const labels = ['2021', '2022', '2023', '2024', '2025'];
ย ย ย ย ย ย const data = [
ย ย ย ย ย ย ย ย props['2021'] || 0,ย props['2022'] || 0,ย props['2023'] || 0,ยย
ย ย ย ย ย ย ย ย props['2024'] || 0,ย props['2025'] || 0
ย ย ย ย ย ย ];
ย ย ย ย ย ย 
ย ย ย ย ย ย const useChartType = chartType || currentChartType;
ย ย ย ย ย ย const total = data.reduce((a, b) => a + b, 0);
ย ย ย ย ย ย const percentages = data.map(value => total > 0 ? Math.round((value / total) * 100) : 0);
ย ย ย ย ย ย 
ย ย ย ย ย ย document.getElementById('chartTitle').textContent = `Distribuciรณn por Aรฑos - Zona: ${zona}`;
ย ย ย ย ย ย updateLegend(labels, data, percentages);
ย ย ย ย ย ย showChartPanel();
ย ย ย ย ย ย 
ย ย ย ย ย ย if (zonaChartInstance) {
ย ย ย ย ย ย ย ย zonaChartInstance.destroy();
ย ย ย ย ย ย }
ย ย ย ย ย ย 
ย ย ย ย ย ย const commonOptions = {
ย ย ย ย ย ย ย ย responsive: true,
ย ย ย ย ย ย ย ย maintainAspectRatio: true,
ย ย ย ย ย ย ย ย layout: { padding: { top: 10, bottom: 20, left: 10, right: 10 } },
ย ย ย ย ย ย ย ย plugins: {
ย ย ย ย ย ย ย ย ย ย legend: { display: false },
ย ย ย ย ย ย ย ย ย ย tooltip: {
ย ย ย ย ย ย ย ย ย ย ย ย callbacks: {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย label: function(context) {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย const label = context.label || '';
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย const value = context.raw || 0;
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย const percentage = percentages[context.dataIndex];
ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย ย return `${label}: ${value} (${percentage}%)`;
ย ย ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย },
ย ย ย ย ย ย ย ย ย ย datalabels: { display: false }ย
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย };
ย ย ย ย ย ย 
ย ย ย ย ย ย if (useChartType === 'pie') {
ย ย ย ย ย ย ย ย Object.assign(commonOptions.plugins, {
ย ย ย ย ย ย ย ย ย ย datalabels: {
ย ย ย ย ย ย ย ย ย ย ย ย color: '#fff',ย
ย ย ย ย ย ย ย ย ย ย ย ย font: { weight: 'bold', size: 11 },
ย ย ย ย ย ย ย ย ย ย ย ย formatter: (value, context) => {
ย ย ย ย ย ย ย ย ย ย ย ย ย ย const percentage = percentages[context.dataIndex];
ย ย ย ย ย ย ย ย ย ย ย ย ย ย return percentage > 5 ? `${percentage}%` : '';
ย ย ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย ย ย Object.assign(commonOptions, { aspectRatio: 1.5 });
ย ย ย ย ย ย }
ย ย ย ย ย ย 
ย ย ย ย ย ย if (useChartType === 'bar') {
ย ย ย ย ย ย ย ย Object.assign(commonOptions, {
ย ย ย ย ย ย ย ย ย ย indexAxis: 'y',
ย ย ย ย ย ย ย ย ย ย scales: { x: { beginAtZero: true }, y: {} }
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย }
ย ย ย ย ย ย 
ย ย ย ย ย ย zonaChartInstance = new Chart(ctx, {
ย ย ย ย ย ย ย ย type: useChartType,
ย ย ย ย ย ย ย ย data: {
ย ย ย ย ย ย ย ย ย ย labels: labels,
ย ย ย ย ย ย ย ย ย ย datasets: [{
ย ย ย ย ย ย ย ย ย ย ย ย data: data,
ย ย ย ย ย ย ย ย ย ย ย ย backgroundColor: chartColors,
ย ย ย ย ย ย ย ย ย ย ย ย borderColor: '#fff',
ย ย ย ย ย ย ย ย ย ย ย ย borderWidth: 2
ย ย ย ย ย ย ย ย ย ย }]
ย ย ย ย ย ย ย ย },
ย ย ย ย ย ย ย ย options: commonOptions
ย ย ย ย ย ย });
ย ย ย ย ย ย 
ย ย ย ย ย ย setTimeout(adjustPanelHeight, 100);
ย ย ย ย }

ย ย ย ย function updateLegend(labels, data, percentages) {
ย ย ย ย ย ย const legend = document.getElementById('chartLegend');
ย ย ย ย ย ย while (legend.rows.length > 1) { legend.deleteRow(1); }
ย ย ย ย ย ย 
ย ย ย ย ย ย labels.forEach((label, index) => {
ย ย ย ย ย ย ย ย if (data[index] > 0 || percentages[index] > 0) {
ย ย ย ย ย ย ย ย ย ย const row = legend.insertRow();
ย ย ย ย ย ย ย ย ย ย const yearCell = row.insertCell();
ย ย ย ย ย ย ย ย ย ย const colorBox = document.createElement('span');
ย ย ย ย ย ย ย ย ย ย colorBox.className = 'legend-color';
ย ย ย ย ย ย ย ย ย ย colorBox.style.backgroundColor = chartColors[index];
ย ย ย ย ย ย ย ย ย ย yearCell.appendChild(colorBox);
ย ย ย ย ย ย ย ย ย ย yearCell.appendChild(document.createTextNode(label));
ย ย ย ย ย ย ย ย ย ย const valueCell = row.insertCell();
ย ย ย ย ย ย ย ย ย ย valueCell.textContent = data[index];
ย ย ย ย ย ย ย ย ย ย const percentCell = row.insertCell();
ย ย ย ย ย ย ย ย ย ย percentCell.textContent = `${percentages[index]}%`;
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย });
ย ย ย ย }

ย ย ย ย function adjustPanelHeight() {
ย ย ย ย ย ย // Solo ajustamos la altura si no estamos en modo mรณvil (donde se fija)
ย ย ย ย ย ย if (isSmallScreen()) return; 

ย ย ย ย ย ย const chartPanel = document.getElementById('chartPanel');
ย ย ย ย ย ย const legend = document.getElementById('chartLegend');
ย ย ย ย ย ย const chartHeight = document.querySelector('.chart-container').offsetHeight;
ย ย ย ย ย ย const legendHeight = legend.offsetHeight;
ย ย ย ย ย ย const titleHeight = document.getElementById('chartTitle').offsetHeight;
ย ย ย ย ย ย const padding = 50;
ย ย ย ย ย ย const totalHeight = chartHeight + legendHeight + titleHeight + padding;
ย ย ย ย ย ย const maxHeight = window.innerHeight * 0.8;
ย ย ย ย ย ย 
ย ย ย ย ย ย if (totalHeight > maxHeight) {
ย ย ย ย ย ย ย ย chartPanel.style.maxHeight = maxHeight + 'px';
ย ย ย ย ย ย ย ย chartPanel.style.overflowY = 'auto';
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย chartPanel.style.maxHeight = '80vh'; // Restaurar para el caso desktop/normal
ย ย ย ย ย ย ย ย chartPanel.style.overflowY = 'visible';
ย ย ย ย ย ย }
ย ย ย ย }
ย ย ย ย 
ย ย ย ย /* ================================================= */
ย ย ย ย /* === OTRAS FUNCIONES Y UTILIDADES === */
ย ย ย ย /* ================================================= */

ย ย ย ย function isSmallScreen() { return window.innerWidth <= 768; }
ย ย ย ย 
ย ย ย ย function initChartPanelState() {
ย ย ย ย ย ย const chartPanel = document.getElementById('chartPanel');
ย ย ย ย ย ย const toggleButton = document.getElementById('toggleChart');
ย ย ย ย ย ย 
ย ย ย ย ย ย // Limpiamos las clases de animaciรณn y restauramos estilos de desktop
ย ย ย ย ย ย chartPanel.classList.remove('is-visible', 'is-hiding');
ย ย ย ย ย ย chartPanel.style.transform = 'none';
ย ย ย ย ย ย chartPanel.style.opacity = 1;
ย ย ย ย ย ย 

ย ย ย ย ย ย if (isSmallScreen()) {
ย ย ย ย ย ย ย ย // Restaura estado para que la animaciรณn funcione en mรณvil al abrir
ย ย ย ย ย ย ย ย chartPanel.style.transform = 'translateX(100%)'; 
ย ย ย ย ย ย ย ย chartPanel.style.opacity = 0; 
ย ย ย ย ย ย ย ย chartPanel.style.display = 'none'; 

ย ย ย ย ย ย ย ย currentChartType = 'bar';
ย ย ย ย ย ย ย ย toggleButton.style.display = 'block'; 
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย // En desktop, lo mostramos por defecto si no ha sido cerrado.
ย ย ย ย ย ย ย ย currentChartType = 'pie';
ย ย ย ย ย ย ย ย chartPanel.style.display = 'block';
ย ย ย ย ย ย ย ย toggleButton.style.display = 'none';
ย ย ย ย ย ย }
ย ย ย ย }
ย ย ย ย 
ย ย ย ย // Toggle Functionality for Stats Panel
ย ย ย ย document.getElementById('cerrarStats').addEventListener('click', function() {
ย ย ย ย ย ย const statsContainer = document.getElementById('statsContainer');
ย ย ย ย ย ย statsContainer.classList.add('hidden');
ย ย ย ย ย ย statsContainer.style.opacity = 0;
ย ย ย ย });
ย ย ย ย 
ย ย ย ย // Click del botรณn "๐ Grรกfico" (solo visible en mรณvil)
ย ย ย ย document.getElementById('toggleChart').addEventListener('click', function() {
ย ย ย ย ย ย // Para forzar la visualizaciรณn en mรณvil, se necesita un Feature para pintar.
ย ย ย ย ย ย // Si no hay una zona seleccionada previamente, usamos el primer elemento de la capa.
ย ย ย ย ย ย const defaultFeature = json_SECTORESESTADISTICAS_1.features[0];
ย ย ย ย ย ย if (defaultFeature) {
ย ย ย ย ย ย ย ย updateChart(defaultFeature.properties['Zona'], defaultFeature.properties);
ย ย ย ย ย ย }
ย ย ย ย });

ย ย ย ย // Click del botรณn "โ" para cerrar el grรกfico
ย ย ย ย document.getElementById('cerrarGrafico').addEventListener('click', function() {
ย ย ย ย ย ย hideChartPanel();
ย ย ย ย });
ย ย ย ย 
ย ย ย ย // =========================================================
ย ย ย ย // === FUNCIรN: GESTIรN DEL MODAL DE AVISO INICIAL ===
ย ย ย ย // =========================================================
ย ย ย ย document.getElementById('acceptDisclaimer').addEventListener('click', function() {
ย ย ย ย ย ย const modal = document.getElementById('disclaimerModal');
ย ย ย ย ย ย 
ย ย ย ย ย ย // Inicia la transiciรณn de desvanecimiento
ย ย ย ย ย ย modal.style.opacity = 0;
ย ย ย ย ย ย 
ย ย ย ย ย ย // Oculta el modal y lo elimina del flujo despuรฉs de la transiciรณn
ย ย ย ย ย ย setTimeout(() => {
ย ย ย ย ย ย ย ย modal.style.display = 'none';
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย ย ย // Iniciar funcionalidades del mapa y estadรญsticas SOLO despuรฉs de aceptar
ย ย ย ย ย ย ย ย map.invalidateSize(); 
ย ย ย ย ย ย ย ย updateStatsOnMove(); 
ย ย ย ย ย ย ย ย 
ย ย ย ย ย ย }, 500);
ย ย ย ย });


ย ย ย ย initChartPanelState();
ย ย ย ย window.addEventListener('resize', initChartPanelState);
ย ย ย ย 
ย ย ย ย document.getElementById('cerrarTexto').addEventListener('click', function() {
ย ย ย ย ย ย const textoPanel = document.getElementById('texto');
ย ย ย ย ย ย textoPanel.style.animation = 'fadeOutUp 0.5s ease-out forwards';
ย ย ย ย ย ย setTimeout(() => { textoPanel.style.display = 'none'; }, 500);
ย ย ย ย });
ย ย ย ย 
ย ย ย ย window.addEventListener('resize', function() {
ย ย ย ย ย ย if (zonaChartInstance) {
ย ย ย ย ย ย ย ย setTimeout(() => { zonaChartInstance.resize(); }, 300);
ย ย ย ย ย ย }
ย ย ย ย });
ย ย ย ย 
ย ย ย ย function createPopupRow(label, value) {
ย ย ย ย ย ย if (value === null) return '';
ย ย ย ย ย ย return `<tr><th scope="row">${label}</th><td>${autolinker.link(String(value))}</td></tr>`;
ย ย ย ย }
ย ย ย ย 
ย ย ย ย function style_SECTORESESTADISTICAS_1_0(feature) {
ย ย ย ย ย ย const zona = String(feature.properties['Zona']);
ย ย ย ย ย ย return {
ย ย ย ย ย ย ย ย pane: 'pane_SECTORESESTADISTICAS_1', opacity: 1, color: 'rgba(35,35,35,1.0)',
ย ย ย ย ย ย ย ย dashArray: '', lineCap: 'butt', lineJoin: 'miter', weight: 1.0, fill: true,
ย ย ย ย ย ย ย ย fillOpacity: 1, fillColor: zonaFillColors[zona] || 'rgba(75,65,216,1.0)', interactive: true
ย ย ย ย ย ย };
ย ย ย ย }
ย ย ย ย 
ย ย ย ย function pop_SECTORESESTADISTICAS_1(feature, layer) {
ย ย ย ย ย ย const props = feature.properties;
ย ย ย ย ย ย 
ย ย ย ย ย ย layer.on('click', function() {
ย ย ย ย ย ย ย ย updateChart(props['Zona'], props);
ย ย ย ย ย ย });
ย ย ย ย ย ย 
ย ย ย ย ย ย // Si no es pantalla pequeรฑa, tambiรฉn mostramos el popup al hacer click
ย ย ย ย ย ย if (!isSmallScreen()) {
ย ย ย ย ย ย ย ย const popupContent = `
ย ย ย ย ย ย ย ย ย ย <table>
ย ย ย ย ย ย ย ย ย ย ย ย ${createPopupRow('Zona', props['Zona'])}
ย ย ย ย ย ย ย ย ย ย ย ย ${createPopupRow('Total', props['Total'])}
ย ย ย ย ย ย ย ย ย ย ย ย ${createPopupRow('2025', props['2025'])}
ย ย ย ย ย ย ย ย ย ย ย ย ${createPopupRow('2024', props['2024'])}
ย ย ย ย ย ย ย ย ย ย ย ย ${createPopupRow('2023', props['2023'])}
ย ย ย ย ย ย ย ย ย ย ย ย ${createPopupRow('2022', props['2022'])}
ย ย ย ย ย ย ย ย ย ย ย ย ${createPopupRow('2021', props['2021'])}
ย ย ย ย ย ย ย ย ย ย </table>
ย ย ย ย ย ย ย ย `;
ย ย ย ย ย ย ย ย const content = popupContent.replace(/null/g, '').replace(/undefined/g, ''); 
ย ย ย ย ย ย ย ย layer.bindPopup(content, { maxHeight: 400 });
ย ย ย ย ย ย }
ย ย ย ย }
ย ย </script>
</body>
</html>
